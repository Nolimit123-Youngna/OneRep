<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chess vs AI</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #eee; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      margin: 20px auto;
      border: 3px solid #333;
      width: 480px;
    }
    .square {
      width: 60px; height: 60px;
      text-align: center;
      font-size: 42px;
      line-height: 60px;
    }
    .light { background: #f0d9b5; }
    .dark { background: #b58863; }
    .square.selected { outline: 3px solid yellow; }
  </style>
</head>
<body>
  <h1>Play Chess vs AI</h1>
  <div id="status"></div>
  <div id="board"></div>
  <button onclick="resetGame()">Reset Game</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script>
    const NGROK_URL = "https://3773ed13fe24.ngrok-free.app";

    let game;
    const boardEl = document.getElementById("board");
    const statusEl = document.getElementById("status");
    let selectedSquare = null;

    function initGame() {
      game = new Chess();
      createBoard();
      updateStatus();
    }

    function createBoard() {
      boardEl.innerHTML = "";
      const board = game.board();
      for (let r = 7; r >= 0; r--) {
        for (let c = 0; c < 8; c++) {
          const square = document.createElement("div");
          square.className = "square " + ((r + c) % 2 === 0 ? "light" : "dark");
          const piece = board[r][c];
          square.textContent = piece ? getUnicode(piece) : "";
          square.onclick = () => handleClick(r, c);
          boardEl.appendChild(square);
        }
      }
    }

    function getUnicode(piece) {
      const symbols = {
        p: "♟", r: "♜", n: "♞", b: "♝", q: "♛", k: "♚",
        P: "♙", R: "♖", N: "♘", B: "♗", Q: "♕", K: "♔"
      };
      return symbols[piece.color === "w" ? piece.type.toUpperCase() : piece.type];
    }

    function handleClick(row, col) {
      if (game.game_over()) return;
      const square = "abcdefgh"[col] + (row + 1);
      const piece = game.get(square);

      if (!selectedSquare) {
        if (piece && piece.color === "w") {
          selectedSquare = square;
        }
      } else {
        const move = game.move({ from: selectedSquare, to: square, promotion: "q" });
        selectedSquare = null;
        if (move) {
          createBoard();
          updateStatus();
          setTimeout(makeAIMove, 200);
        } else {
          if (piece && piece.color === "w") {
            selectedSquare = square;
          }
        }
      }
    }

    async function makeAIMove() {
      if (game.game_over()) return;
      try {
        const res = await fetch(`${NGROK_URL}/move`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fen: game.fen() })
        });
        const data = await res.json();
        if (data.best_move) {
          game.move({
            from: data.best_move.slice(0, 2),
            to: data.best_move.slice(2, 4),
            promotion: "q"
          });
          createBoard();
          updateStatus();
        }
      } catch (err) {
        console.error("AI request failed:", err);
      }
    }

    function updateStatus() {
      if (game.in_checkmate()) {
        statusEl.textContent = "Checkmate! " + (game.turn() === "w" ? "Black" : "White") + " wins.";
      } else if (game.in_draw()) {
        statusEl.textContent = "Draw!";
      } else if (game.in_check()) {
        statusEl.textContent = (game.turn() === "w" ? "White" : "Black") + " is in check.";
      } else {
        statusEl.textContent = (game.turn() === "w" ? "White" : "Black") + "'s turn.";
      }
    }

    function resetGame() {
      game.reset();
      selectedSquare = null;
      createBoard();
      updateStatus();
    }

    window.onload = initGame;
  </script>
</body>
</html>
